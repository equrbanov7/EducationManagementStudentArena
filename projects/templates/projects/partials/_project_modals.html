{% if request.user.is_teacher %}

<!-- ADD MODAL -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Yeni Kurs İşi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createProjectForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Başlıq <span class="text-danger">*</span></label>
                            <input type="text" name="title" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="active">Aktiv</option>
                                <option value="inactive">Deaktiv</option>
                                <option value="archived">Arxivləndi</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Təsvir</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Başlanğıc <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Son tarix <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="deadline" class="form-control" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Maks. cəhd</label>
                            <input type="number" name="max_attempts" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Maks. bal</label>
                            <input type="number" name="max_score" class="form-control" value="100" min="1">
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">İcazəli Qruplar</label>
                            <input type="text" class="form-control mb-2" id="addGroupSearch" placeholder="Qrup axtar...">
                            <div id="addGroupList" class="border rounded" style="max-height:250px;overflow-y:auto;"></div>
                            <small class="text-muted">Seçilib: <span id="addGroupCount">0</span></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">İcazəli Tələbələr</label>
                            <input type="text" class="form-control mb-2" id="addStudentSearch" placeholder="Tələbə axtar...">
                            <div id="addStudentList" class="border rounded" style="max-height:250px;overflow-y:auto;">
                                <p class="text-muted text-center py-3">Əvvəlcə qrup seçin</p>
                            </div>
                            <small class="text-muted">Seçilib: <span id="addStudentCount">0</span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bağla</button>
                    <button type="submit" class="btn btn-info"><i class="bi bi-check"></i> Əlavə Et</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Redaktə Et</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProjectForm">
                {% csrf_token %}
                <input type="hidden" id="editProjectId" name="project_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Başlıq <span class="text-danger">*</span></label>
                            <input type="text" id="editTitle" name="title" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select id="editStatus" name="status" class="form-select">
                                <option value="active">Aktiv</option>
                                <option value="inactive">Deaktiv</option>
                                <option value="archived">Arxivləndi</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Təsvir</label>
                        <textarea id="editDescription" name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Başlanğıc <span class="text-danger">*</span></label>
                            <input type="datetime-local" id="editStartDate" name="start_date" class="form-control" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Son tarix <span class="text-danger">*</span></label>
                            <input type="datetime-local" id="editDeadline" name="deadline" class="form-control" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Maks. cəhd</label>
                            <input type="number" id="editMaxAttempts" name="max_attempts" class="form-control" min="1">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Maks. bal</label>
                            <input type="number" id="editMaxScore" name="max_score" class="form-control" min="1">
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">İcazəli Qruplar</label>
                            <input type="text" class="form-control mb-2" id="editGroupSearch" placeholder="Qrup axtar...">
                            <div id="editGroupList" class="border rounded" style="max-height:250px;overflow-y:auto;"></div>
                            <small class="text-muted">Seçilib: <span id="editGroupCount">0</span></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">İcazəli Tələbələr</label>
                            <input type="text" class="form-control mb-2" id="editStudentSearch" placeholder="Tələbə axtar...">
                            <div id="editStudentList" class="border rounded" style="max-height:250px;overflow-y:auto;">
                                <p class="text-muted text-center py-3">Əvvəlcə qrup seçin</p>
                            </div>
                            <small class="text-muted">Seçilib: <span id="editStudentCount">0</span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bağla</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> Yadda Saxla</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endif %}

<style>
.chk-row{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;cursor:pointer}
.chk-row:hover{background:#f5f9ff}
.chk-row:last-child{border-bottom:none}
.chk-row input{width:18px;height:18px;margin-right:10px}
.chk-row label{margin:0;flex:1;cursor:pointer}
.chk-row .badge{margin-left:auto}
</style>

<script>
(function(){
    if(window._PROJ_MODAL_V4) return;
    window._PROJ_MODAL_V4 = true;

    const COURSE_ID = {{ course.id }};
    const CSRF = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const $ = id => document.getElementById(id);

    // ═══════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════
    
    // Edit modal üçün - serverdən gələn orijinal tələbə ID-ləri
    let editSavedStudentIds = new Set();

    // ═══════════════════════════════════════════════════════════
    // HELPERS
    // ═══════════════════════════════════════════════════════════
    
    const esc = s => s ? String(s).replace(/[<>&"']/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'})[c]) : '';
    
    const toLocal = dt => {
        if(!dt) return '';
        const d = new Date(dt);
        if(isNaN(d)) return '';
        const p = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    const updateCount = mode => {
        const gc = document.querySelectorAll(`#${mode}GroupList input:checked`).length;
        const sc = document.querySelectorAll(`#${mode}StudentList input:checked`).length;
        if($(mode+'GroupCount')) $(mode+'GroupCount').textContent = gc;
        if($(mode+'StudentCount')) $(mode+'StudentCount').textContent = sc;
    };

    // ═══════════════════════════════════════════════════════════
    // LOAD GROUPS
    // ═══════════════════════════════════════════════════════════
    
    function loadGroups(mode, checkedGroups = []) {
        const container = $(mode + 'GroupList');
        container.innerHTML = '<p class="text-muted text-center py-3">Yüklənir...</p>';

        fetch(`/projects/api/groups/?course_id=${COURSE_ID}`)
            .then(r => r.json())
            .then(data => {
                const groups = data.groups || [];
                if(!groups.length) {
                    container.innerHTML = '<p class="text-muted text-center py-3">Qrup yoxdur</p>';
                    return;
                }

                container.innerHTML = groups.map(g => `
                    <div class="chk-row">
                        <input type="checkbox" id="${mode}G${g.id}" name="group_names[]" value="${esc(g.name)}" 
                               data-group="${esc(g.name)}" ${checkedGroups.includes(g.name)?'checked':''}>
                        <label for="${mode}G${g.id}">${esc(g.name)}</label>
                    </div>
                `).join('');

                container.querySelectorAll('input').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateCount(mode);
                        loadStudents(mode);
                    });
                });

                updateCount(mode);
                
                // Qruplar yükləndikdən sonra tələbələri yüklə
                if(checkedGroups.length) loadStudents(mode);
            })
            .catch(() => {
                container.innerHTML = '<p class="text-danger text-center py-3">Xəta</p>';
            });
    }

    // ═══════════════════════════════════════════════════════════
    // LOAD STUDENTS
    // ═══════════════════════════════════════════════════════════
    
    function loadStudents(mode) {
        const container = $(mode + 'StudentList');
        
        // Seçilmiş qrupları tap
        const groups = Array.from(document.querySelectorAll(`#${mode}GroupList input:checked`))
                           .map(cb => cb.dataset.group);

        if(!groups.length) {
            container.innerHTML = '<p class="text-muted text-center py-3">Əvvəlcə qrup seçin</p>';
            updateCount(mode);
            return;
        }

        container.innerHTML = '<p class="text-muted text-center py-3">Yüklənir...</p>';

        fetch(`/projects/api/students/?course_id=${COURSE_ID}&groups=${encodeURIComponent(groups.join(','))}`)
            .then(r => r.json())
            .then(data => {
                const students = data.students || [];
                if(!students.length) {
                    container.innerHTML = '<p class="text-muted text-center py-3">Tələbə yoxdur</p>';
                    updateCount(mode);
                    return;
                }

                container.innerHTML = students.map(s => {
                    // ════════════════════════════════════════════════════════
                    // ƏSAS: Edit modunda yalnız savedStudentIds-də olanları check et
                    // Add modunda heç birini check etmə
                    // ════════════════════════════════════════════════════════
                    let isChecked = '';
                    if(mode === 'edit' && editSavedStudentIds.has(s.id)) {
                        isChecked = 'checked';
                    }
                    
                    return `
                        <div class="chk-row">
                            <input type="checkbox" id="${mode}S${s.id}" name="students[]" value="${s.id}" ${isChecked}>
                            <label for="${mode}S${s.id}">${esc(s.name)}</label>
                            <span class="badge bg-secondary">${esc(s.group_name)}</span>
                        </div>
                    `;
                }).join('');

                container.querySelectorAll('input').forEach(cb => {
                    cb.addEventListener('change', () => updateCount(mode));
                });

                updateCount(mode);
            })
            .catch(() => {
                container.innerHTML = '<p class="text-danger text-center py-3">Xəta</p>';
            });
    }

    // ═══════════════════════════════════════════════════════════
    // SEARCH
    // ═══════════════════════════════════════════════════════════
    
    ['add','edit'].forEach(mode => {
        $(mode+'GroupSearch')?.addEventListener('input', e => {
            const t = e.target.value.toLowerCase();
            document.querySelectorAll(`#${mode}GroupList .chk-row`).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(t) ? '' : 'none';
            });
        });
        $(mode+'StudentSearch')?.addEventListener('input', e => {
            const t = e.target.value.toLowerCase();
            document.querySelectorAll(`#${mode}StudentList .chk-row`).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(t) ? '' : 'none';
            });
        });
    });

    // ═════════════════════════════════���═════════════════════════
    // ADD MODAL
    // ═══════════════════════════════════════════════════════════
    
    $('addProjectModal')?.addEventListener('shown.bs.modal', () => {
        $('addStudentList').innerHTML = '<p class="text-muted text-center py-3">Əvvəlcə qrup seçin</p>';
        loadGroups('add');
    });

    $('addProjectModal')?.addEventListener('hidden.bs.modal', () => {
        $('createProjectForm').reset();
    });

    $('createProjectForm')?.addEventListener('submit', e => {
        e.preventDefault();
        const btn = e.target.querySelector('[type=submit]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch(`/projects/create/${COURSE_ID}/`, {
            method: 'POST',
            body: new FormData(e.target),
            headers: {'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(d => d.success ? location.reload() : alert('Xəta: ' + (d.error||'')))
        .catch(() => alert('Server xətası'))
        .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="bi bi-check"></i> Əlavə Et'; });
    });

    // ═══════════════════════════════════════════════════════════
    // EDIT MODAL
    // ═══════════════════════════════════════════════════════════
    
    document.addEventListener('click', e => {
        const btn = e.target.closest('.js-edit-project');
        if(!btn) return;
        e.preventDefault();

        const url = btn.dataset.url;
        
        // RESET
        editSavedStudentIds.clear();
        $('editGroupList').innerHTML = '<p class="text-muted text-center py-3">Yüklənir...</p>';
        $('editStudentList').innerHTML = '<p class="text-muted text-center py-3">Yüklənir...</p>';

        bootstrap.Modal.getOrCreateInstance($('editProjectModal')).show();

        fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(res => {
                if(!res.success) return alert('Məlumat alınmadı');
                
                const d = res.data;
                
                // Form doldur
                $('editProjectId').value = d.id;
                $('editTitle').value = d.title || '';
                $('editDescription').value = d.description || '';
                $('editStartDate').value = toLocal(d.start_date);
                $('editDeadline').value = toLocal(d.deadline);
                $('editMaxAttempts').value = d.max_attempts || 1;
                $('editMaxScore').value = d.max_score || 100;
                $('editStatus').value = d.status || 'active';

                // ════════════════════════════════════════════════════════
                // ƏSAS: Serverdən gələn tələbə ID-lərini SAXLA
                // Bu set loadStudents() funksiyasında istifadə olunacaq
                // ════════════════════════════════════════════════════════
                editSavedStudentIds = new Set(d.student_ids || []);
                
                console.log('Saved student IDs:', editSavedStudentIds);

                // Qrupları yüklə
                loadGroups('edit', d.group_names || []);
            })
            .catch(() => alert('Xəta'));
    });

    $('editProjectForm')?.addEventListener('submit', e => {
        e.preventDefault();
        const projectId = $('editProjectId').value;
        if(!projectId) return;

        const btn = e.target.querySelector('[type=submit]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch(`/projects/${projectId}/edit/`, {
            method: 'POST',
            body: new FormData(e.target),
            headers: {'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(d => d.success ? location.reload() : alert('Xəta: ' + (d.error||'')))
        .catch(() => alert('Server xətası'))
        .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="bi bi-check"></i> Yadda Saxla'; });
    });

    // ═══════════════════════════════════════════════════════════
    // DELETE
    // ═══════════════════════════════════════════════════════════
    
    document.addEventListener('click', e => {
        const btn = e.target.closest('.js-delete-project');
        if(!btn) return;
        e.preventDefault();
        if(!confirm('Silmək istədiyinizə əminsiniz?')) return;

        fetch(btn.dataset.url, {
            method: 'POST',
            headers: {'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(d => d.success ? location.reload() : alert('Xəta'))
        .catch(() => alert('Server xətası'));
    });

})();
</script>