{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if is_editing %}
        {{ exam.title }} - Redaktə
    {% else %}
        Yeni imtahan
    {% endif %}
{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="{% static 'css/createAndEditExam.css' %}">
    <link rel="stylesheet" href="{% static 'css/_searchable_multi_select.css' %}">
{% endblock %}
 
{% block content %}
    <div class="create-exam-page-wrapper">
        <div class="create-exam-card">
            <div class="card-header">
                {% if is_editing %}
                    <h1><i class="fas fa-edit"></i> İmtahanı redaktə et</h1>
                    <p>"{{ exam.title }}" imtahanını yeniləyin.</p>
                {% else %}
                    <h1><i class="fas fa-plus-circle"></i> Yeni imtahan yarat</h1>
                    <p>Tələbələr üçün yeni bir bilik yoxlaması hazırlayın.</p>
                {% endif %}
            </div>

            <form method="post" class="exam-form" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="form-global-errors">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="form-grid">
                    {# --- Başlıq --- #}
                    <div class="form-group span-full">
                        {{ form.title.label_tag }}
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="field-error">{{ form.title.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Təsvir --- #}
                    <div class="form-group span-full">
                        {{ form.description.label_tag }}
                        {{ form.description }}
                        <small class="form-text text-muted">
                            İmtahan haqqında qısa məlumat.
                        </small>
                        {% if form.description.errors %}
                            <div class="field-error">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Tip + Aktivlik --- #}
                    <div class="form-group">
                        {{ form.exam_type.label_tag }}
                        {{ form.exam_type }}
                        {% if form.exam_type.errors %}
                            <div class="field-error">{{ form.exam_type.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group span-full">
                        {% if form.enable_paint %}
                            <div class="form-check mt-2">
                                {{ form.enable_paint }}
                                <label class="form-check-label" for="{{ form.enable_paint.id_for_label }}">
                                    Paint cavabı aktiv olsun
                                </label>
                                <small class="form-text text-muted">
                                    Aktiv edilsə, tələbələr cavabı çəkmə (paint) ilə göndərə biləcək.
                                </small>
                                {% if form.enable_paint.errors %}
                                    <div class="text-danger small">{{ form.enable_paint.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group checkbox-group">
                        <label for="{{ form.is_active.id_for_label }}" class="checkbox-label-wrapper">
                            {{ form.is_active }}
                            <span class="custom-checkbox-box"></span>
                            {{ form.is_active.label }}
                        </label>
                        {% if form.is_active.errors %}
                            <div class="field-error">{{ form.is_active.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# ================= TARIX BLOKU ================= #}
                    <div class="form-section-title span-full">
                        <h2><i class="far fa-clock text-primary"></i> Tarix məhdudiyyətləri</h2>
                        <p>İmtahanın aktiv qalacağı müddəti təyin edin.</p>
                    </div>

                    <div class="date-range-wrapper span-full">
                        
                        {# --- START DATE --- #}
                        <div class="date-card">
                            <div class="date-card-header">
                                <span class="badge-start">Başlama</span>
                                <i class="far fa-calendar-alt icon-faded"></i>
                            </div>
                            <div class="date-input-container">
                                {{ form.start_datetime }}
                            </div>
                            <div class="date-footer">
                                <small>Bu tarixdən tez başlamaq olmaz.</small>
                                <small>Boş buraxsan, hər zaman başlamaq olar.</small>
                            </div>
                            {% if form.start_datetime.errors %}
                                <div class="field-error-floating">{{ form.start_datetime.errors.0 }}</div>
                            {% endif %}
                        </div>

                        {# --- ARROW INDICATOR --- #}
                        <div class="date-separator">
                            <i class="fas fa-arrow-right"></i>
                        </div>

                        {# --- END DATE --- #}
                        <div class="date-card">
                            <div class="date-card-header">
                                <span class="badge-end">Bitmə</span>
                                <i class="far fa-calendar-times icon-faded"></i>
                            </div>
                            <div class="date-input-container">
                                {{ form.end_datetime }}
                            </div>
                            <div class="date-footer">
                                <small>Bu tarixdən sonra deaktiv olur.</small>
                                <small>Boş buraxsan, heç vaxt bitməz.</small>
                            </div>
                            {% if form.end_datetime.errors %}
                                <div class="field-error-floating">{{ form.end_datetime.errors.0 }}</div>
                            {% endif %}
                        </div>

                    </div>

                    {# ================= VAXT PARAMETRLƏRİ ================= #}
                    <div class="form-section-title span-full">
                        <h2><i class="fas fa-stopwatch text-info"></i> Vaxt parametrləri</h2>
                        <p>İmtahan müddəti və sual vaxtlarını təyin edin.</p>
                    </div>

                    <div class="form-group">
                        {{ form.total_duration_minutes.label_tag }}
                        <div class="input-with-icon">
                            {{ form.total_duration_minutes }}
                            <i class="far fa-clock icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Ümumi imtahan müddəti (dəqiqə). Boş buraxsan, ümumi limit olmayacaq.
                        </small>
                        {% if form.total_duration_minutes.errors %}
                            <div class="field-error">{{ form.total_duration_minutes.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form.default_question_time_seconds.label_tag }}
                        <div class="input-with-icon">
                            {{ form.default_question_time_seconds }}
                            <i class="fas fa-stopwatch icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Hər sual üçün varsayılan vaxt (saniyə). Boş buraxsan, sual-sual limit olmayacaq.
                        </small>
                        {% if form.default_question_time_seconds.errors %}
                            <div class="field-error">{{ form.default_question_time_seconds.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form.max_attempts_per_user.label_tag }}
                        <div class="input-with-icon">
                            {{ form.max_attempts_per_user }}
                            <i class="fas fa-redo icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Bir istifadəçi üçün maksimum cəhd sayı. Boş buraxsan, limitsiz olacaq.
                        </small>
                        {% if form.max_attempts_per_user.errors %}
                            <div class="field-error">{{ form.max_attempts_per_user.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# ================= GİRİŞ HÜQUQLARI BLOKU ================= #}
                    <div class="form-section-title span-full">
                        <h2><i class="fas fa-users text-success"></i> Giriş hüquqları</h2>
                        <p>İmtahanı kimlərin görə biləcəyini burada idarə et.</p>
                    </div>

                    {# --- Hamı üçün açıq? --- #}
                    <div class="form-group checkbox-group span-full">
                        <label for="{{ form.is_public.id_for_label }}" class="checkbox-label-wrapper">
                            {{ form.is_public }}
                            <span class="custom-checkbox-box"></span>
                            <span>
                                Hamı üçün açıqdır?
                                <small class="checkbox-help">
                                    İşarələsən, bütün tələbələr imtahanı görə biləcək. 
                                    İşarəni götürsən, yalnız seçdiyin qrup və istifadəçilər görə bilər.
                                </small>
                            </span>
                        </label>
                        {% if form.is_public.errors %}
                            <div class="field-error">{{ form.is_public.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {# --- Məhdudlaşdırılmış giriş (PARTIAL İSTİFADƏSİ) --- #}
                    <div id="access-restrictions" class="access-section span-full">
                        <div class="access-section-grid">
                            
                            {# PARTIAL 1: Qruplar üçün #}
                            {% include "partials/_searchable_multi_select.html" with field=form.allowed_groups label="İcazəli Qruplar" search_placeholder="Qrup axtar..." container_id="groupSelector" %}

                            {# PARTIAL 2: Tələbələr üçün #}
                            {% include "partials/_searchable_multi_select.html" with field=form.allowed_users label="İcazəli Tələbələr (Fərdi)" search_placeholder="Tələbə axtar (ad, username)..." container_id="userSelector" %}

                        </div>

                        <p class="access-help mt-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Əgər heç kim seçilməsə və "Hamı üçün açıq" deyilsə, imtahanı yalnız siz görə biləcəksiniz.
                        </p>
                    </div>

                    {# --- İmtahan kodu --- #}
                    <div class="form-group span-full">
                        {{ form.access_code.label_tag }}
                        <div class="input-with-icon">
                            {{ form.access_code }}
                            <i class="fas fa-key icon"></i>
                        </div>
                        <small class="form-text text-muted">
                            Optional: 6 rəqəmli kod yazsan, imtahana girməzdən əvvəl tələbədən bu kod tələb olunacaq.
                            Boş buraxsan, kod tələb olunmayacaq.
                        </small>
                        {% if form.access_code.errors %}
                            <div class="field-error">{{ form.access_code.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions">
                    {% if is_editing %}
                        <a href="{% url 'teacher_exam_detail' exam.slug %}" class="btn-cancel">
                            <i class="fas fa-times"></i> Ləğv et
                        </a>
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-save"></i> Dəyişiklikləri saxla
                        </button>
                    {% else %}
                        <a href="javascript:history.back()" class="btn-cancel">
                            <i class="fas fa-times"></i> Ləğv et
                        </a>
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-check"></i> Yarat
                        </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    
            // PUBLIC / PRIVATE TOGGLE
            const isPublicCheckbox = document.getElementById("{{ form.is_public.id_for_label }}");
            const accessBlock = document.getElementById("access-restrictions");
    
            function toggleAccessBlock() {
                if (!isPublicCheckbox || !accessBlock) return;
                
                if (isPublicCheckbox.checked) {
                    accessBlock.classList.add('closed');
                } else {
                    accessBlock.classList.remove('closed');
                }
            }
    
            if (isPublicCheckbox && accessBlock) {
                toggleAccessBlock();
                isPublicCheckbox.addEventListener("change", toggleAccessBlock);
            }
        });
    </script>

{% endblock %}