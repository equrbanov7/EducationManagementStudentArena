{% extends "base.html" %}
{% load static %}

{% block title %}{{ profile_user.username }} | Profil{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-page-wrapper">
    <header class="profile-section-header">
        <h1><span>{{ profile_user.username }}</span> Profili</h1>
        <p class="profile-subheading">Ä°stifadÉ™Ã§inin yaratdÄ±ÄŸÄ± mÉ™qalÉ™lÉ™r</p>

        {% if request.user.is_authenticated and request.user == profile_user %}
             <a href="{% url 'create_post' %}" class="profile-create-post-btn">
               <i class="fas fa-plus-circle"></i> Yeni post yarat
             </a>

             {% if request.user.is_teacher %}
                 <a href="{% url 'teacher_exam_list' %}" class="profile-create-post-btn">
                      <i class="fas fa-file-alt"></i> Ä°mtahanlarÄ±m
                 </a>
                 <a href="{% url 'create_exam' %}" class="profile-create-post-btn">
                      <i class="fas fa-plus-square"></i> Yeni imtahan yarat
                 </a>
            {% endif %}
        {% endif %}
    </header>

    <section class="profile-posts-section">
        {% if posts %}
            {% for post in posts %}
                <article class="profile-post-card">
                    <h3>
                        <a href="{% url 'post_detail' post.slug %}">
                            {{ post.title }}
                        </a>
                    </h3>
                    <p>{{ post.excerpt|default:post.content|truncatewords:25 }}</p>
                    <small>ğŸ“… {{ post.created_at|date:"d M Y" }}</small>

                    {% if request.user == profile_user %}
                        <div class="post-actions">
                            <button class="action-btn edit-btn js-edit-post"
                                    data-post-id="{{ post.pk }}"
                                    data-title="{{ post.title|escapejs }}"
                                    data-content="{{ post.content|escapejs }}"
                                    data-category="{{ post.category.id|default_if_none:'' }}"
                                    data-excerpt="{{ post.excerpt|default_if_none:''|escapejs }}">
                                <i class="fas fa-edit"></i> RedaktÉ™
                            </button>
                            <button class="action-btn delete-btn js-open-delete"
                                    data-post-id="{{ post.pk }}"
                                    data-title="{{ post.title|escapejs }}">
                                <i class="fas fa-trash"></i> Sil
                            </button>
                        </div>
                    {% endif %}
                </article>
            {% endfor %}
        {% else %}
            <p class="profile-no-posts-message">Bu istifadÉ™Ã§inin hÉ™lÉ™ heÃ§ bir postu yoxdur.</p>
        {% endif %}
    </section>

    {# Edit Modal #}
    <div id="editModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Postu RedaktÉ™ Et</h3>
                <button class="modal-close-btn" id="closeEditModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="editTitle">BaÅŸlÄ±q</label>
                    <input type="text" id="editTitle" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editCategory">Kateqoriya</label>
                    <select id="editCategory" name="category" class="form-control" required>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="editExcerpt">QÄ±sa mÉ™zmun</label>
                    <textarea id="editExcerpt" name="excerpt" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="editContent">MÉ™zmun</label>
                    <textarea id="editContent" name="content" class="form-control" rows="10" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancelEdit" class="modal-cancel-btn">LÉ™ÄŸv Et</button>
                    <button type="submit" id="saveEdit" class="modal-confirm-btn" disabled>Yadda Saxla</button>
                </div>
            </form>
        </div>
    </div>

    {# Delete Confirmation Modal #}
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <h3>SilinmÉ™ni TÉ™sdiqlÉ™</h3>
            <p>Æminsiniz ki, <span id="deleteTitle" class="fw-bold"></span> baÅŸlÄ±qlÄ± postu silmÉ™k istÉ™yirsiniz?</p>
            <div class="modal-buttons">
                <button id="cancelDelete" class="modal-cancel-btn">LÉ™ÄŸv Et</button>
                {# Burda .delete-btn yalnÄ±z dizayn Ã¼Ã§Ã¼ndÃ¼r, JS selektoru artÄ±q .js-open-delete-dir #}
                <button id="confirmDelete" class="modal-confirm-btn delete-btn">Sil</button>
            </div>
        </div>
    </div>

    {# Unsaved Changes Warning Modal #}
    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Yadda SaxlanÄ±lmamÄ±ÅŸ DÉ™yiÅŸikliklÉ™r</h3>
            <p>Postda etdiyiniz dÉ™yiÅŸikliklÉ™r yadda saxlanÄ±lmayÄ±b. Saxlamadan Ã§Ä±xmaq istÉ™yirsiniz?</p>
            <div class="modal-buttons">
                <button id="stayOnModal" class="modal-cancel-btn">Qal</button>
                <button id="discardChanges" class="modal-confirm-btn warning-btn">Saxlamadan Ã‡Ä±x</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extraJs %}
    <script src="{% static 'js/user_profile.js' %}"></script>
{% endblock %}
