<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Player</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 18px; }
    .wrap { max-width: 900px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .pin { font-weight:700; font-size:18px; }
    .timer { font-size:18px; font-weight:700; padding:8px 12px; border:1px solid #eee; border-radius:10px; min-width:110px; text-align:center; }
    .card { margin-top:14px; padding:14px; border:1px solid #eee; border-radius:14px; }
    .qtext { font-size:20px; font-weight:700; margin-bottom:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .opt {
      padding:14px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-size:16px;
      text-align:left;
    }
    .opt:disabled { opacity:.55; cursor:not-allowed; }
    .opt.selected { border:2px solid #000; }

    .actions { margin-top: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }

    .status { margin-top:10px; font-weight:600; }
    .good { color: #0a7d2a; }
    .bad { color: #b30000; }
    .small { opacity:.75; font-size:13px; }

    .lb { margin-top:12px; }
    .lb h3 { margin: 0 0 8px; }
    .lb ol { margin: 0; padding-left: 18px; }
    .lb li { margin: 6px 0; }
    .pill { display:inline-block; padding:4px 10px; border:1px solid #eee; border-radius:999px; font-size:12px; opacity:.8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pin">PIN: {{ session.pin }}</div>
      <div>
        <span class="pill" id="connPill">WS: qo≈üulur...</span>
      </div>
      <div class="timer" id="timerBox">--</div>
    </div>

    <div class="card" id="mainCard">
      <div class="qtext" id="qText">G√∂zl…ôyin... m√º…ôllim oyunu ba≈üladƒ±r.</div>

      <div class="grid" id="optionsGrid" style="display:none;"></div>

      <!-- ‚úÖ Multi √º√ß√ºn submit -->
      <div class="actions" id="actionBar" style="display:none;">
        <button class="btn" id="submitBtn" type="button" disabled>Submit</button>
        <span class="pill" id="multiHint" style="display:none;"></span>
      </div>

      <div class="status" id="statusLine"></div>
      <div class="small" id="metaLine"></div>

      <div class="lb" id="lbWrap" style="display:none;">
        <h3>üèÜ Leaderboard</h3>
        <ol id="lbList"></ol>

        <div style="margin-top:10px;">
          <div class="pill">Bu sual √ºzr…ô n…ôtic…ôl…ôr</div>
          <ol id="resultList" style="margin-top:8px;"></ol>
        </div>
      </div>
    </div>
  </div>

<script>
  const pin = "{{ session.pin }}";
  const connPill = document.getElementById("connPill");
  const timerBox = document.getElementById("timerBox");
  const qText = document.getElementById("qText");
  const optionsGrid = document.getElementById("optionsGrid");
  const statusLine = document.getElementById("statusLine");
  const metaLine = document.getElementById("metaLine");

  const actionBar = document.getElementById("actionBar");
  const submitBtn = document.getElementById("submitBtn");
  const multiHint = document.getElementById("multiHint");

  const lbWrap = document.getElementById("lbWrap");
  const lbList = document.getElementById("lbList");
  const resultList = document.getElementById("resultList");

  let currentQuestion = null;   // {id, text, options, ends_at, started_at, index, total, multi, max_select}
  let selectedOptionId = null;  // single
  let selectedOptionIds = new Set(); // multi
  let answered = false;
  let timerInterval = null;

  function wsUrl(path){
    const proto = location.protocol === "https:" ? "wss" : "ws";
    return `${proto}://${location.host}${path}`;
  }

  function fmt2(n){ return String(n).padStart(2, "0"); }

  function setConn(ok){
    connPill.textContent = ok ? "WS: qo≈üuldu ‚úÖ" : "WS: k…ôsildi ‚ùå";
  }

  function clearTimer(){
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    timerBox.textContent = "--";
  }

  function stopAnswerUI(){
    document.querySelectorAll(".opt").forEach(b => b.disabled = true);
    submitBtn.disabled = true;
  }

  function startTimer(endsAtISO){
    clearTimer();
    if (!endsAtISO) return;

    const ends = new Date(endsAtISO).getTime();

    function tick(){
      const now = Date.now();
      const diff = Math.max(0, ends - now);
      const sec = Math.ceil(diff / 1000);
      const mm = Math.floor(sec / 60);
      const ss = sec % 60;
      timerBox.textContent = `${fmt2(mm)}:${fmt2(ss)}`;

      if (diff <= 0){
        stopAnswerUI();
        if (!answered) {
          statusLine.textContent = "Vaxt bitdi. N…ôtic…ô g√∂zl…ônilir...";
          statusLine.className = "status";
        }
      }
    }

    tick();
    timerInterval = setInterval(tick, 250);
  }

  function isMulti(q){
    return !!(q && q.multi);
  }

  function maxSelect(q){
    const v = Number(q && q.max_select);
    return Number.isFinite(v) && v > 0 ? v : 1;
  }

  function updateMultiHint(){
    if (!isMulti(currentQuestion)) {
      multiHint.style.display = "none";
      return;
    }
    multiHint.style.display = "inline-block";
    const maxS = maxSelect(currentQuestion);
    multiHint.textContent = `Multi: ${selectedOptionIds.size}/${maxS}`;
  }

  function resetUIForQuestion(q){
    currentQuestion = q;
    answered = false;

    selectedOptionId = null;
    selectedOptionIds = new Set();

    lbWrap.style.display = "none";
    lbList.innerHTML = "";
    resultList.innerHTML = "";

    statusLine.textContent = "";
    statusLine.className = "status";

    metaLine.textContent = (q?.index && q?.total) ? `Sual: ${q.index}/${q.total}` : "";

    qText.textContent = q?.text || "Sual...";
    optionsGrid.innerHTML = "";
    optionsGrid.style.display = "grid";

    // ‚úÖ action bar (submit) yalnƒ±z multi √º√ß√ºn
    if (isMulti(q)) {
      actionBar.style.display = "flex";
      submitBtn.disabled = true;
      updateMultiHint();
    } else {
      actionBar.style.display = "none";
    }

    (q.options || []).forEach((opt, idx) => {
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.type = "button";
      btn.dataset.id = opt.id;

      const letters = ["A","B","C","D","E","F"];
      const label = (opt.label ?? opt.key ?? opt.code ?? letters[idx] ?? String(idx+1));
      const text  = (opt.text ?? opt.title ?? opt.content ?? opt.answer ?? "").toString();

      btn.textContent = `${label}) ${text}`;

      btn.onclick = () => {
        if (answered) return;

        if (!isMulti(q)) {
          // single: click -> submit immediately
          selectedOptionId = opt.id;
          document.querySelectorAll(".opt").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          submitAnswerSingle();
          return;
        }

        // multi: toggle selection with max_select limit
        const maxS = maxSelect(q);

        if (selectedOptionIds.has(opt.id)) {
          selectedOptionIds.delete(opt.id);
          btn.classList.remove("selected");
        } else {
          if (selectedOptionIds.size >= maxS) return;
          selectedOptionIds.add(opt.id);
          btn.classList.add("selected");
        }

        submitBtn.disabled = (selectedOptionIds.size === 0);
        updateMultiHint();
      };

      optionsGrid.appendChild(btn);
    });

    // ‚úÖ multi submit
    submitBtn.onclick = () => {
      if (!isMulti(currentQuestion) || answered) return;
      if (selectedOptionIds.size === 0) return;
      submitAnswerMulti();
    };

    startTimer(q.ends_at);
  }

  function calcAnswerMs(){
    const startedAt = currentQuestion?.started_at ? new Date(currentQuestion.started_at).getTime() : null;
    return startedAt ? Math.max(0, Date.now() - startedAt) : 0;
  }

  function submitAnswerSingle(){
    if (!currentQuestion || !selectedOptionId) return;

    answered = true;
    stopAnswerUI();

    statusLine.textContent = "Cavab g√∂nd…ôrildi. N…ôtic…ô g√∂zl…ônilir...";
    statusLine.className = "status";

    try {
      playWs.send(JSON.stringify({
        type: "answer",
        question_id: currentQuestion.id,
        option_id: selectedOptionId,
        answer_ms: calcAnswerMs()
      }));
    } catch(e) {}
  }

  function submitAnswerMulti(){
    if (!currentQuestion) return;

    answered = true;
    stopAnswerUI();

    statusLine.textContent = "Cavab g√∂nd…ôrildi. N…ôtic…ô g√∂zl…ônilir...";
    statusLine.className = "status";

    try {
      playWs.send(JSON.stringify({
        type: "answer",
        question_id: currentQuestion.id,
        option_ids: Array.from(selectedOptionIds),
        answer_ms: calcAnswerMs()
      }));
    } catch(e) {}
  }

  function renderReveal(msg){
    clearTimer();
    stopAnswerUI();

    const correctIds = (msg.correct_option_ids || []).map(Number);
    const correctSet = new Set(correctIds);

    let isCorrect = false;

    if (answered) {
      if (isMulti(currentQuestion)) {
        const sel = new Set(Array.from(selectedOptionIds).map(Number));
        // perfect match (consumer d…ô perfect flag saxlayƒ±r)
        isCorrect = (sel.size === correctSet.size) && Array.from(sel).every(x => correctSet.has(x));
      } else {
        isCorrect = correctSet.has(Number(selectedOptionId));
      }

      statusLine.textContent = isCorrect ? "‚úÖ D√ºz cavab!" : "‚ùå S…ôhv cavab.";
      statusLine.className = "status " + (isCorrect ? "good" : "bad");
    } else {
      statusLine.textContent = "Vaxt bitdi / cavab verm…ôdin.";
      statusLine.className = "status bad";
    }

    // Leaderboard
    lbWrap.style.display = "block";
    lbList.innerHTML = "";
    (msg.top || []).forEach((p, i) => {
      const li = document.createElement("li");
      li.textContent = `${i+1}. ${p.nickname} ‚Äî ${p.score} bal`;
      lbList.appendChild(li);
    });

    // Bu sual √ºzr…ô n…ôtic…ôl…ôr
    resultList.innerHTML = "";
    (msg.results || []).slice(0, 20).forEach(r => {
      const li = document.createElement("li");
      li.textContent = `${r.nickname}: ${r.is_correct ? "‚úÖ" : "‚ùå"} +${r.awarded_points} (total ${r.total_score})`;
      resultList.appendChild(li);
    });

    metaLine.textContent = (currentQuestion?.index && currentQuestion?.total)
      ? `Sual: ${currentQuestion.index}/${currentQuestion.total} ‚Äî N√∂vb…ôti sual g√∂zl…ônilir...`
      : "N√∂vb…ôti sual g√∂zl…ônilir...";
  }

  function renderFinished(msg){
    clearTimer();
    stopAnswerUI();
    qText.textContent = "Oyun bitdi ‚úÖ";
    optionsGrid.style.display = "none";
    actionBar.style.display = "none";

    lbWrap.style.display = "block";
    lbList.innerHTML = "";
    (msg.top || []).forEach((p, i) => {
      const li = document.createElement("li");
      li.textContent = `${i+1}. ${p.nickname} ‚Äî ${p.score} bal`;
      lbList.appendChild(li);
    });
    resultList.innerHTML = "";
  }

  // ‚úÖ WebSocket
  const playWs = new WebSocket(wsUrl(`/ws/live/${pin}/play/`));

  playWs.onopen = async () => {
    setConn(true);

    // Fallback: cari v…ôziyy…ôti HTTP il…ô √ß…ôk
    try {
      const res = await fetch(`/live/state/${pin}/`, { headers: { "Accept": "application/json" }});
      const st = await res.json();

      if (st.ok && st.question) {
        resetUIForQuestion(st.question);
        if (st.state === "reveal") {
          renderReveal({ correct_option_ids: st.correct_option_ids || [], top: [], results: [] });
        }
      }
    } catch(e){}
  };

  playWs.onclose = () => setConn(false);
  playWs.onerror = () => setConn(false);

  playWs.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === "question_published") {
      resetUIForQuestion(msg.question);
      return;
    }

    // ‚úÖ consumer cavabdan sonra bunu qaytarƒ±r
    if (msg.type === "answer_saved") {
      // bonus + fraction kimi m…ôlumatlarƒ± user-…ô g√∂st…ôr…ô bil…ôrik
      const frac = (msg.fraction != null) ? ` (fraction ${msg.fraction})` : "";
      const pts = (msg.awarded_points != null) ? ` +${msg.awarded_points} bal` : "";
      statusLine.textContent = `Cavab saxlanƒ±ldƒ±.${pts}${frac} ‚Äî N…ôtic…ô g√∂zl…ônilir...`;
      statusLine.className = "status";
      return;
    }

    if (msg.type === "reveal") {
      renderReveal(msg);
      return;
    }

    if (msg.type === "finished") {
      renderFinished(msg);
      return;
    }
  };
</script>
</body>
</html>
