{% extends "base.html" %}
{% load static %}

{% block title %}Game Host | {{ session.pin }}{% endblock %}

{% block extraCss %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/host_lobby.css' %}">
{% endblock %}

{% block content %}
    <div class="host-container">
        
        <header id="lobbyHeader" class="lobby-header">
            <div class="lobby-title">üöÄ Live ƒ∞mtahan Lobby</div>
            <div class="pin-display" id="displayPin">{{ session.pin }}</div>
            
            <div class="join-info">
                <div class="qr-box">
                    <img src="{{ qr_url }}" alt="QR Code" width="160" onclick="toggleQR(true)" title="B√∂y√ºtm…ôk √º√ß√ºn klikl…ô">
                </div>
                <div class="link-box">
                    <div style="font-size: 0.9rem; color:#888; margin-bottom:5px;">Brauzerd…ô yaz:</div>
                    <a href="{{ join_url }}" target="_blank" style="color:#00bcd4; font-weight:bold; font-size:1.5rem; text-decoration:none;">
                       LearnHub.it / {{ session.pin }}
                    </a>
                </div>
            </div> 
        </header>

        <div class="control-bar">
            <button id="startBtn" class="btn-3d btn-start">
                <i class="fas fa-play"></i> Start
            </button>

            <div class="settings-group">
                <i class="fas fa-list-ol"></i>
                <span style="font-size:0.9rem; font-weight:700; color:#455a64;">Sual sayƒ±:</span>
            
                <input
                    id="questionCount"
                    type="number"
                    min="1"
                    max="{{ exam_total_questions }}"
                    value="5"
                    style="width:55px; border:none; background:transparent; font-weight:900; color:#455a64; text-align:center;"
                />
            
                <small style="opacity:0.7; font-weight:700; color:#455a64;">
                    / {{ exam_total_questions }}
                </small>
            </div>
            

            <button id="revealBtn" class="btn-3d btn-reveal" disabled>
                <i class="fas fa-eye"></i> Reveal
            </button>
            
            <button id="nextBtn" class="btn-3d btn-next" disabled>
                <i class="fas fa-forward"></i> Next
            </button>
            
            <button id="finishBtn" class="btn-3d btn-finish">
                <i class="fas fa-stop"></i> Finish
            </button>

            <div class="settings-group" style="cursor:pointer;" onclick="document.getElementById('autoMode').click()">
                <input type="checkbox" id="autoMode" checked>
                <span style="font-size:0.9rem;">Auto</span>
            </div>

            <span id="gameState" style="background:#263238; color:#00e676; padding:5px 10px; border-radius:5px; font-size:0.8rem; font-family:monospace;">LOBBY</span>
        </div>

        <div id="questionWrap" style="display:none;">
            <div class="q-header">
                <span id="qMeta" style="font-weight:700; color:#888; font-size:1.1rem;">Sual 1/10</span>
                <div class="timer-circle" id="qTimer">--</div>
            </div>
            <div id="qText" class="q-text">Sual m…ôtni...</div>
            <div id="qOptions" class="options-grid"></div>
        </div>

        <div id="leaderWrap" style="display:none;">
            <h2 style="text-align:center; color:var(--primary); font-weight:900; margin-bottom:20px;">
                <i class="fas fa-trophy" style="color:gold;"></i> Leaderboard
            </h2>
            <div id="leaderList"></div>
        </div>

        <div class="players-section">
            <div class="players-header">
                <h3 style="margin:0; font-weight:800;">
                    <i class="fas fa-users"></i> Qo≈üulanlar: 
                    <span id="playersCount" style="background:white; color:var(--primary); padding:2px 10px; border-radius:10px;">0</span>
                </h3>
                <small style="opacity:0.8;">Total: {{ exam_total_questions }} sual</small>
            </div>
            <div id="playersList" class="players-grid"></div>
        </div>

        <div style="margin-top:20px; opacity:0.75; text-align:center;">
            <button id="debugBtn" type="button"
                    style="background:none;border:none;cursor:pointer;color:white;font-weight:700;">
              Debug Logs ‚ñ∏
            </button>
          
            <div id="hostLog"
                 style="display:none;text-align:left;background:#000;color:#0f0;
                        padding:12px;max-height:160px;overflow:auto;margin-top:10px;
                        border-radius:10px;white-space:pre-wrap;
                        font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
                        line-height:1.35;">
              Ready.
            </div>
          </div>
          

    </div>

    <div id="qrModal" class="qr-modal" onclick="toggleQR(false)">
        <img src="{{ qr_url }}" alt="QR Big">
        <p style="position:absolute; bottom:5%; color:white; font-weight:bold; font-size:1.5rem;">Qo≈üulmaq √º√ß√ºn skan et!</p>
    </div>

    {% block extraJs %}
        <script>
            const GAME_CONFIG = {
                pin: "{{ session.pin }}",
                csrf: "{{ csrf_token }}",
                urls: {
                    start: "{% url 'liveExam:start_game' session.pin %}",
                    endQuestion: "{% url 'liveExam:end_question' session.pin %}",
                    nextQuestion: "{% url 'liveExam:next_question' session.pin %}",
                    finish: "{% url 'liveExam:finish_game' session.pin %}"
                }
            };

            // QR Modal Funksiyasƒ±
            function toggleQR(show) {
                const modal = document.getElementById('qrModal');
                // ∆èg…ôr oyun ba≈ülayƒ±bsa (lobbyHeader gizlidirs…ô) modalƒ± a√ßmaƒüa icaz…ô verm…ô
                const header = document.getElementById('lobbyHeader');
                if (show && header.style.display === 'none') return;
                
                modal.style.display = show ? 'flex' : 'none';
            }
        </script>
        <script src="{% static 'js/host_lobby.js' %}"></script>
    {% endblock %}

{% endblock %}