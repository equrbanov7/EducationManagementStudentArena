{% load static %}

<!-- ════════════════════════════════════════════════════════════════ -->
<!-- ACCORDION 6: ÜZVLƏR (Members)                                   -->
<!-- ════════════════════════════════════════════════════════════════ -->
<div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" 
                data-bs-toggle="collapse" data-bs-target="#memberCollapse">
            <i class="fas fa-users text-success me-2"></i>
            <strong>Üzvlər</strong>
            <span class="badge bg-success ms-2" id="accordion-members-count">{{ members|length }}</span>
        </button>
    </h2>
    <div id="memberCollapse" class="accordion-collapse collapse" 
         data-bs-parent="#courseDashboard">
        <div class="accordion-body">
            
            {% if is_owner %}
            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-primary btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addStudentModal">
                    <i class="fas fa-user-plus"></i> Tələbə Əlavə Et
                </button>
                <button class="btn btn-secondary btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#addGroupModal">
                    <i class="fas fa-users-cog"></i> Qrup Əlavə Et
                </button>
                <a href="{% url 'courses:course_members' course.id %}" 
                   class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-eye"></i> Hamısını Gör
                </a>
            </div>
            {% endif %}

            <!-- Members Preview -->
            {% if members %}
                <div class="list-group">
                    {% for member in members|slice:":5" %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" id="member-row-{{ member.id }}">
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar-circle">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <strong>{{ member.user.get_full_name|default:member.user.username }}</strong>
                                    <br>
                                    <small class="text-muted">@{{ member.user.username }}</small>
                                </div>
                            </div>
                        
                            <div class="d-flex align-items-center gap-2">
                                <div>
                                    {% if member.role == 'teacher' %}
                                        <span class="badge bg-warning">Müəllim</span>
                                    {% elif member.role == 'assistant' %}
                                        <span class="badge bg-info">Köməkçi</span>
                                    {% else %}
                                        <span class="badge bg-success">Tələbə</span>
                                        {% if member.group_name %}
                                            <small class="text-muted ms-1">({{ member.group_name }})</small>
                                        {% endif %}
                                    {% endif %}
                                </div>
                        
                                {# ✅ SİL düyməsi - yalnız owner görsün və teacher silinməsin #}
                                {% if is_owner and member.role != 'teacher' %}
                                <button type="button" 
                                    onclick="deleteMember({{ member.id }}, '{{ member.user.username }}')" 
                                    class="btn btn-sm btn-outline-danger">
                                   <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    
                    
                    {% if members|length > 5 %}
                    <a href="{% url 'courses:course_members' course.id %}" 
                       class="list-group-item list-group-item-action text-center text-primary">
                        <i class="fas fa-ellipsis-h"></i> Daha {{ members|length|add:"-5" }} nəfər...
                    </a>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Hələ üzv əlavə olunmayıb.
                </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
</style>

<script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
  
    document.addEventListener("click", async function(e) {
      const btn = e.target.closest(".js-delete-member");
      if (!btn) return;
  
      const url = btn.dataset.url;
      const memberId = btn.dataset.memberId;
  
      if (!confirm("Bu istifadəçini kursdan silmək istəyirsən?")) return;
  
      btn.disabled = true;
  
      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
          }
        });
  
        const data = await resp.json();
  
        if (!resp.ok || !data.success) {
          alert(data.error || "Silinmə zamanı xəta baş verdi.");
          btn.disabled = false;
          return;
        }
  
        // ✅ DOM-dan sil
        const row = document.getElementById(`member-row-${memberId}`);
        if (row) row.remove();

        function decCountById(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const n = parseInt(el.textContent || "0", 10);
            el.textContent = Math.max(0, n - 1);
          }
          
          // DOM-dan siləndən sonra:
          decCountById("sidebar-members-count");
          decCountById("accordion-members-count");
          
  
        // ✅ Badge sayını azalt (accordion header-də olan yaşıl badge)
        const badge = document.querySelector('#memberCollapse')
          ?.closest('.accordion-item')
          ?.querySelector('.accordion-header .badge');
  
        if (badge) {
          const n = parseInt(badge.textContent || "0", 10);
          badge.textContent = Math.max(0, n - 1);
        }
  
      } catch (err) {
        console.error(err);
        alert("Şəbəkə xətası.");
        btn.disabled = false;
      }
    });
  </script>
  